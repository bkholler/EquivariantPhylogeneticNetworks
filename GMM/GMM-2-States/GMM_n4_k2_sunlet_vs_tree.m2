load("../../PhylogeneticNetworks.m2")
load("../GMM_Networks.m2")
needsPackage "MultigradedImplicitization"

-- create the ring and the vanishing ideal of the 2-state GMM on a 4-sunlet with reticulation 1 and leaves labelled cyclically
n = 4
k = 2
S = pRing(k, n)
I = ideal(p_(0,0,1,1)*p_(0,1,0,0)*p_(0,1,0,1)*p_(1,0,0,0)-p_(0,0,1,0)*p_(0,1,0,1)^2*p_(1,0,0,0)+p_(0,0,0,1)*p_(0,1,0,1)*p_(0,1,1,0)*p_(1,0,0,0)-p_(0,0,0,1)*p_(0,1,0,0)*p_(0,1,1,1)*p_(1,0,0,0)-p_(0,0,1,1)*p_(0,1,0,0)^2*p_(1,0,0,1)+p_(0,0,1,0)*p_(0,1,0,0)*p_(0,1,0,1)*p_(1,0,0,1)-p_(0,0,0,0)*p_(0,1,0,1)*p_(0,1,1,0)*p_(1,0,0,1)+p_(0,0,0,0)*p_(0,1,0,0)*p_(0,1,1,1)*p_(1,0,0,1)-p_(0,0,0,1)*p_(0,1,0,0)*p_(0,1,0,1)*p_(1,0,1,0)+p_(0,0,0,0)*p_(0,1,0,1)^2*p_(1,0,1,0)+p_(0,0,0,1)*p_(0,1,0,0)^2*p_(1,0,1,1)-p_(0,0,0,0)*p_(0,1,0,0)*p_(0,1,0,1)*p_(1,0,1,1)+p_(0,0,0,1)*p_(0,0,1,0)*p_(0,1,0,1)*p_(1,1,0,0)-p_(0,0,0,0)*p_(0,0,1,1)*p_(0,1,0,1)*p_(1,1,0,0)-p_(0,0,0,1)^2*p_(0,1,1,0)*p_(1,1,0,0)+p_(0,0,0,0)*p_(0,0,0,1)*p_(0,1,1,1)*p_(1,1,0,0)-2*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,0,0,1)*p_(1,1,0,0)+2*p_(0,0,1,0)*p_(0,1,0,1)*p_(1,0,0,1)*p_(1,1,0,0)-2*p_(0,0,0,1)*p_(0,1,1,0)*p_(1,0,0,1)*p_(1,1,0,0)+2*p_(0,0,0,0)*p_(0,1,1,1)*p_(1,0,0,1)*p_(1,1,0,0)+p_(0,1,1,1)*p_(1,0,0,0)*p_(1,0,0,1)*p_(1,1,0,0)-p_(0,1,1,0)*p_(1,0,0,1)^2*p_(1,1,0,0)+p_(0,1,0,1)*p_(1,0,0,1)*p_(1,0,1,0)*p_(1,1,0,0)+2*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,0,1,1)*p_(1,1,0,0)-2*p_(0,0,0,0)*p_(0,1,0,1)*p_(1,0,1,1)*p_(1,1,0,0)-p_(0,1,0,1)*p_(1,0,0,0)*p_(1,0,1,1)*p_(1,1,0,0)-p_(0,0,1,1)*p_(1,0,0,1)*p_(1,1,0,0)^2+p_(0,0,0,1)*p_(1,0,1,1)*p_(1,1,0,0)^2-p_(0,0,0,1)*p_(0,0,1,0)*p_(0,1,0,0)*p_(1,1,0,1)+p_(0,0,0,0)*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,1,0,1)+p_(0,0,0,0)*p_(0,0,0,1)*p_(0,1,1,0)*p_(1,1,0,1)-p_(0,0,0,0)^2*p_(0,1,1,1)*p_(1,1,0,1)+2*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,0,0,0)*p_(1,1,0,1)-2*p_(0,0,1,0)*p_(0,1,0,1)*p_(1,0,0,0)*p_(1,1,0,1)+2*p_(0,0,0,1)*p_(0,1,1,0)*p_(1,0,0,0)*p_(1,1,0,1)-2*p_(0,0,0,0)*p_(0,1,1,1)*p_(1,0,0,0)*p_(1,1,0,1)-p_(0,1,1,1)*p_(1,0,0,0)^2*p_(1,1,0,1)+p_(0,1,1,0)*p_(1,0,0,0)*p_(1,0,0,1)*p_(1,1,0,1)-2*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,0,1,0)*p_(1,1,0,1)+2*p_(0,0,0,0)*p_(0,1,0,1)*p_(1,0,1,0)*p_(1,1,0,1)-p_(0,1,0,0)*p_(1,0,0,1)*p_(1,0,1,0)*p_(1,1,0,1)+p_(0,1,0,0)*p_(1,0,0,0)*p_(1,0,1,1)*p_(1,1,0,1)+p_(0,0,1,1)*p_(1,0,0,0)*p_(1,1,0,0)*p_(1,1,0,1)+p_(0,0,1,0)*p_(1,0,0,1)*p_(1,1,0,0)*p_(1,1,0,1)-p_(0,0,0,1)*p_(1,0,1,0)*p_(1,1,0,0)*p_(1,1,0,1)-p_(0,0,0,0)*p_(1,0,1,1)*p_(1,1,0,0)*p_(1,1,0,1)-p_(0,0,1,0)*p_(1,0,0,0)*p_(1,1,0,1)^2+p_(0,0,0,0)*p_(1,0,1,0)*p_(1,1,0,1)^2+p_(0,0,0,1)^2*p_(0,1,0,0)*p_(1,1,1,0)-p_(0,0,0,0)*p_(0,0,0,1)*p_(0,1,0,1)*p_(1,1,1,0)+2*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,0,0,1)*p_(1,1,1,0)-2*p_(0,0,0,0)*p_(0,1,0,1)*p_(1,0,0,1)*p_(1,1,1,0)-p_(0,1,0,1)*p_(1,0,0,0)*p_(1,0,0,1)*p_(1,1,1,0)+p_(0,1,0,0)*p_(1,0,0,1)^2*p_(1,1,1,0)+p_(0,0,0,1)*p_(1,0,0,0)*p_(1,1,0,1)*p_(1,1,1,0)-p_(0,0,0,0)*p_(1,0,0,1)*p_(1,1,0,1)*p_(1,1,1,0)-p_(0,0,0,0)*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,1,1,1)+p_(0,0,0,0)^2*p_(0,1,0,1)*p_(1,1,1,1)-2*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,0,0,0)*p_(1,1,1,1)+2*p_(0,0,0,0)*p_(0,1,0,1)*p_(1,0,0,0)*p_(1,1,1,1)+p_(0,1,0,1)*p_(1,0,0,0)^2*p_(1,1,1,1)-p_(0,1,0,0)*p_(1,0,0,0)*p_(1,0,0,1)*p_(1,1,1,1)-p_(0,0,0,1)*p_(1,0,0,0)*p_(1,1,0,0)*p_(1,1,1,1)+p_(0,0,0,0)*p_(1,0,0,1)*p_(1,1,0,0)*p_(1,1,1,1),p_(0,0,1,1)*p_(0,1,0,1)*p_(0,1,1,0)*p_(1,0,0,0)-p_(0,0,1,0)*p_(0,1,0,1)*p_(0,1,1,1)*p_(1,0,0,0)-p_(0,0,1,1)*p_(0,1,0,0)*p_(0,1,1,0)*p_(1,0,0,1)+p_(0,0,1,0)*p_(0,1,0,0)*p_(0,1,1,1)*p_(1,0,0,1)-p_(0,0,0,1)*p_(0,1,0,0)*p_(0,1,1,1)*p_(1,0,1,0)+p_(0,0,0,0)*p_(0,1,0,1)*p_(0,1,1,1)*p_(1,0,1,0)+p_(0,0,0,1)*p_(0,1,0,0)*p_(0,1,1,0)*p_(1,0,1,1)-p_(0,0,0,0)*p_(0,1,0,1)*p_(0,1,1,0)*p_(1,0,1,1)-p_(0,0,0,1)*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,1,0,0)+p_(0,0,0,1)*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,1,0,0)-2*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,0,0,1)*p_(1,1,0,0)+2*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,0,0,1)*p_(1,1,0,0)+p_(0,1,1,1)*p_(1,0,0,1)*p_(1,0,1,0)*p_(1,1,0,0)-p_(0,1,1,0)*p_(1,0,0,1)*p_(1,0,1,1)*p_(1,1,0,0)+p_(0,0,0,0)*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,1,0,1)-p_(0,0,0,0)*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,1,0,1)+2*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,0,0,0)*p_(1,1,0,1)-2*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,0,0,0)*p_(1,1,0,1)-p_(0,1,1,1)*p_(1,0,0,0)*p_(1,0,1,0)*p_(1,1,0,1)+p_(0,1,1,0)*p_(1,0,0,0)*p_(1,0,1,1)*p_(1,1,0,1)+p_(0,0,0,1)*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,1,1,0)-p_(0,0,0,0)*p_(0,0,1,1)*p_(0,1,0,1)*p_(1,1,1,0)+2*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,0,1,1)*p_(1,1,1,0)-2*p_(0,0,0,0)*p_(0,1,0,1)*p_(1,0,1,1)*p_(1,1,1,0)-p_(0,1,0,1)*p_(1,0,0,0)*p_(1,0,1,1)*p_(1,1,1,0)+p_(0,1,0,0)*p_(1,0,0,1)*p_(1,0,1,1)*p_(1,1,1,0)-p_(0,0,1,1)*p_(1,0,0,1)*p_(1,1,0,0)*p_(1,1,1,0)+p_(0,0,0,1)*p_(1,0,1,1)*p_(1,1,0,0)*p_(1,1,1,0)+p_(0,0,1,1)*p_(1,0,0,0)*p_(1,1,0,1)*p_(1,1,1,0)-p_(0,0,0,0)*p_(1,0,1,1)*p_(1,1,0,1)*p_(1,1,1,0)-p_(0,0,0,1)*p_(0,0,1,0)*p_(0,1,0,0)*p_(1,1,1,1)+p_(0,0,0,0)*p_(0,0,1,0)*p_(0,1,0,1)*p_(1,1,1,1)-2*p_(0,0,0,1)*p_(0,1,0,0)*p_(1,0,1,0)*p_(1,1,1,1)+2*p_(0,0,0,0)*p_(0,1,0,1)*p_(1,0,1,0)*p_(1,1,1,1)+p_(0,1,0,1)*p_(1,0,0,0)*p_(1,0,1,0)*p_(1,1,1,1)-p_(0,1,0,0)*p_(1,0,0,1)*p_(1,0,1,0)*p_(1,1,1,1)+p_(0,0,1,0)*p_(1,0,0,1)*p_(1,1,0,0)*p_(1,1,1,1)-p_(0,0,0,1)*p_(1,0,1,0)*p_(1,1,0,0)*p_(1,1,1,1)-p_(0,0,1,0)*p_(1,0,0,0)*p_(1,1,0,1)*p_(1,1,1,1)+p_(0,0,0,0)*p_(1,0,1,0)*p_(1,1,0,1)*p_(1,1,1,1),p_(0,0,1,1)*p_(0,1,1,0)*p_(0,1,1,1)*p_(1,0,0,0)-p_(0,0,1,0)*p_(0,1,1,1)^2*p_(1,0,0,0)-p_(0,0,1,1)*p_(0,1,1,0)^2*p_(1,0,0,1)+p_(0,0,1,0)*p_(0,1,1,0)*p_(0,1,1,1)*p_(1,0,0,1)+p_(0,0,1,1)*p_(0,1,0,1)*p_(0,1,1,0)*p_(1,0,1,0)-p_(0,0,1,1)*p_(0,1,0,0)*p_(0,1,1,1)*p_(1,0,1,0)-p_(0,0,0,1)*p_(0,1,1,0)*p_(0,1,1,1)*p_(1,0,1,0)+p_(0,0,0,0)*p_(0,1,1,1)^2*p_(1,0,1,0)-p_(0,0,1,0)*p_(0,1,0,1)*p_(0,1,1,0)*p_(1,0,1,1)+p_(0,0,0,1)*p_(0,1,1,0)^2*p_(1,0,1,1)+p_(0,0,1,0)*p_(0,1,0,0)*p_(0,1,1,1)*p_(1,0,1,1)-p_(0,0,0,0)*p_(0,1,1,0)*p_(0,1,1,1)*p_(1,0,1,1)-p_(0,0,1,1)^2*p_(0,1,1,0)*p_(1,1,0,0)+p_(0,0,1,0)*p_(0,0,1,1)*p_(0,1,1,1)*p_(1,1,0,0)-2*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,0,1,1)*p_(1,1,0,0)+2*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,0,1,1)*p_(1,1,0,0)+p_(0,1,1,1)*p_(1,0,1,0)*p_(1,0,1,1)*p_(1,1,0,0)-p_(0,1,1,0)*p_(1,0,1,1)^2*p_(1,1,0,0)+p_(0,0,1,0)*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,1,0,1)-p_(0,0,1,0)^2*p_(0,1,1,1)*p_(1,1,0,1)+2*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,0,1,0)*p_(1,1,0,1)-2*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,0,1,0)*p_(1,1,0,1)-p_(0,1,1,1)*p_(1,0,1,0)^2*p_(1,1,0,1)+p_(0,1,1,0)*p_(1,0,1,0)*p_(1,0,1,1)*p_(1,1,0,1)+p_(0,0,1,1)^2*p_(0,1,0,0)*p_(1,1,1,0)-p_(0,0,1,0)*p_(0,0,1,1)*p_(0,1,0,1)*p_(1,1,1,0)+p_(0,0,0,1)*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,1,1,0)-p_(0,0,0,0)*p_(0,0,1,1)*p_(0,1,1,1)*p_(1,1,1,0)-2*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,0,0,1)*p_(1,1,1,0)+2*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,0,0,1)*p_(1,1,1,0)+p_(0,1,1,1)*p_(1,0,0,1)*p_(1,0,1,0)*p_(1,1,1,0)+2*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,0,1,1)*p_(1,1,1,0)-2*p_(0,0,1,0)*p_(0,1,0,1)*p_(1,0,1,1)*p_(1,1,1,0)+2*p_(0,0,0,1)*p_(0,1,1,0)*p_(1,0,1,1)*p_(1,1,1,0)-2*p_(0,0,0,0)*p_(0,1,1,1)*p_(1,0,1,1)*p_(1,1,1,0)-p_(0,1,1,1)*p_(1,0,0,0)*p_(1,0,1,1)*p_(1,1,1,0)-p_(0,1,0,1)*p_(1,0,1,0)*p_(1,0,1,1)*p_(1,1,1,0)+p_(0,1,0,0)*p_(1,0,1,1)^2*p_(1,1,1,0)+p_(0,0,1,1)*p_(1,0,1,0)*p_(1,1,0,1)*p_(1,1,1,0)-p_(0,0,1,0)*p_(1,0,1,1)*p_(1,1,0,1)*p_(1,1,1,0)-p_(0,0,1,1)*p_(1,0,0,1)*p_(1,1,1,0)^2+p_(0,0,0,1)*p_(1,0,1,1)*p_(1,1,1,0)^2-p_(0,0,1,0)*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,1,1,1)+p_(0,0,1,0)^2*p_(0,1,0,1)*p_(1,1,1,1)-p_(0,0,0,1)*p_(0,0,1,0)*p_(0,1,1,0)*p_(1,1,1,1)+p_(0,0,0,0)*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,1,1,1)+2*p_(0,0,1,1)*p_(0,1,1,0)*p_(1,0,0,0)*p_(1,1,1,1)-2*p_(0,0,1,0)*p_(0,1,1,1)*p_(1,0,0,0)*p_(1,1,1,1)-2*p_(0,0,1,1)*p_(0,1,0,0)*p_(1,0,1,0)*p_(1,1,1,1)+2*p_(0,0,1,0)*p_(0,1,0,1)*p_(1,0,1,0)*p_(1,1,1,1)-2*p_(0,0,0,1)*p_(0,1,1,0)*p_(1,0,1,0)*p_(1,1,1,1)+2*p_(0,0,0,0)*p_(0,1,1,1)*p_(1,0,1,0)*p_(1,1,1,1)-p_(0,1,1,0)*p_(1,0,0,1)*p_(1,0,1,0)*p_(1,1,1,1)+p_(0,1,0,1)*p_(1,0,1,0)^2*p_(1,1,1,1)+p_(0,1,1,0)*p_(1,0,0,0)*p_(1,0,1,1)*p_(1,1,1,1)-p_(0,1,0,0)*p_(1,0,1,0)*p_(1,0,1,1)*p_(1,1,1,1)-p_(0,0,1,1)*p_(1,0,1,0)*p_(1,1,0,0)*p_(1,1,1,1)+p_(0,0,1,0)*p_(1,0,1,1)*p_(1,1,0,0)*p_(1,1,1,1)+p_(0,0,1,1)*p_(1,0,0,0)*p_(1,1,1,0)*p_(1,1,1,1)+p_(0,0,1,0)*p_(1,0,0,1)*p_(1,1,1,0)*p_(1,1,1,1)-p_(0,0,0,1)*p_(1,0,1,0)*p_(1,1,1,0)*p_(1,1,1,1)-p_(0,0,0,0)*p_(1,0,1,1)*p_(1,1,1,0)*p_(1,1,1,1)-p_(0,0,1,0)*p_(1,0,0,0)*p_(1,1,1,1)^2+p_(0,0,0,0)*p_(1,0,1,0)*p_(1,1,1,1)^2);

-- compute the vanishing ideal of a 3-leaf tree under the 2-state GMM with multigraded implicitization
T = digraph({1,2,3,4,5,6}, {{6, 5}, {5, 3}, {5, 1}, {6, 2}, {6, 4}})
phi = gmmTreeParametrization(k, T);
KK = ZZ/32003
R = KK[gens target phi]
S = KK[gens source phi]
psi = map(R, S, sub(matrix phi, R));

-- make the grading matrix
A = transpose matrix for x in gens(S) list(

	l = last baseName x; 

	flatten for l' in l list apply(k, i -> if i == l' then 1 else 0)
);
B = submatrix'(A, toList(0..k-1),)

-- compute the polynomials with interpolation and then verify its the right ideal over QQ after the fact
H = componentsOfKernel(3, psi, Grading => B, UseInterpolation => true);
J = sub(ideal delete(null, flatten values H), ring I)
isPrime J
dim(J)

-- check that I_N and I_T are mutually not contained
isSubset(I, J)
isSubset(J, I)